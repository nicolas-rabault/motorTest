<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motor Test Results Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .motor-selector {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .motor-selector label {
            font-weight: 500;
            font-size: 1.1rem;
        }

        select {
            padding: 10px 20px;
            font-size: 1rem;
            border: none;
            border-radius: 8px;
            background: white;
            color: #333;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        select:hover {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        select:focus {
            outline: 3px solid rgba(255, 255, 255, 0.5);
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            overflow: visible;
        }

        .section-title {
            font-size: 1.3rem;
            color: #1e3c72;
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 12px;
            cursor: help;
            position: relative;
        }

        .info-icon:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 25px;
            top: -5px;
            background: #1e3c72;
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            white-space: pre-wrap;
            max-width: 300px;
            font-size: 13px;
            z-index: 1000;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            line-height: 1.4;
        }

        .card-tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 0;
            top: 100%;
            margin-top: 8px;
            background: #1e3c72;
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            white-space: pre-wrap;
            max-width: 280px;
            width: max-content;
            font-size: 12px;
            z-index: 10000;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            line-height: 1.4;
            pointer-events: none;
        }

        .card-tooltip {
            position: relative;
            cursor: help;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
            overflow: visible;
        }

        .card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            transition: all 0.3s;
            position: relative;
            overflow: visible;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.12);
            z-index: 100;
        }

        .card-label {
            font-size: 0.85rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .card-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 5px;
        }

        .card-unit {
            font-size: 0.9rem;
            color: #999;
        }

        .card-description {
            font-size: 0.85rem;
            color: #666;
            margin-top: 10px;
            font-style: italic;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 15px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-gimbal {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-high-current {
            background: #fff3e0;
            color: #f57c00;
        }

        .test-history {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .test-entry {
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid #667eea;
        }

        .test-type {
            font-weight: 600;
            color: #1e3c72;
        }

        .test-time {
            color: #666;
            font-size: 0.9rem;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        .info-panel {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .info-panel h3 {
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .info-panel p {
            line-height: 1.6;
            color: #555;
            margin-bottom: 10px;
        }

        .info-panel ul {
            margin-left: 20px;
            line-height: 1.8;
            color: #555;
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 1.2rem;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #c62828;
        }

        .highlight-positive {
            color: #2e7d32;
        }

        .highlight-warning {
            color: #f57c00;
        }

        .overview-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .compact-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .overview-grid {
                grid-template-columns: 1fr;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            header {
                text-align: center;
                justify-content: center;
            }

            h1 {
                font-size: 1.5rem;
            }
        }

        .burst-test-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            overflow: visible;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            position: relative;
            overflow: visible;
        }

        .summary-card:hover {
            z-index: 100;
        }

        .summary-card-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .summary-card-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <span>‚ö°</span>
                <span>Motor Test Results Viewer</span>
            </h1>
            <div class="motor-selector">
                <input type="file" id="fileInput" accept=".json" style="display: none;">
                <button id="loadFileBtn" style="padding: 12px 30px; font-size: 1rem; border: none; border-radius: 8px; background: white; color: #333; cursor: pointer; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: all 0.3s; font-weight: 500;">
                    üìÅ Load Result File
                </button>
            </div>
        </header>

        <div class="content" id="content">
            <div class="loading">Loading motor data...</div>
        </div>
    </div>

    <script>
        let currentMotorData = null;
        let burstChart = null;
        let tempChart = null;

        // Check for URL parameter on page load
        function checkUrlParameter() {
            const urlParams = new URLSearchParams(window.location.search);
            const filename = urlParams.get('file');

            if (filename) {
                // Load file from results directory
                loadResultFile(filename);
            }
        }

        // Load a result file from the results directory
        async function loadResultFile(filename) {
            try {
                document.getElementById('content').innerHTML = '<div class="loading">Loading ' + filename + '...</div>';

                const response = await fetch('results/' + filename);

                if (!response.ok) {
                    throw new Error('Failed to load file: ' + filename);
                }

                const data = await response.json();
                currentMotorData = data;
                displayMotorData(data);
            } catch (error) {
                document.getElementById('content').innerHTML = `
                    <div class="error">
                        <strong>Error loading result file:</strong> ${error.message}
                        <br><br>
                        <a href="docs/index.html" style="color: #1976d2; text-decoration: underline;">‚Üê Back to result selector</a>
                    </div>
                `;
            }
        }

        // Handle file selection
        document.getElementById('loadFileBtn').addEventListener('click', function() {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    currentMotorData = data;
                    displayMotorData(data);
                } catch (error) {
                    document.getElementById('content').innerHTML = `
                        <div class="error">
                            <strong>Error parsing JSON file:</strong> ${error.message}
                        </div>
                    `;
                }
            };
            reader.readAsText(file);
        });

        // Check for URL parameter when page loads
        checkUrlParameter();

        // Display motor data
        function displayMotorData(data) {
            if (!data) return;

            const content = document.getElementById('content');

            content.innerHTML = `
                <div class="overview-grid">
                    <div class="section">
                        <div class="section-title">üìã Motor Overview</div>
                        <div class="cards-grid">
                            <div class="card card-tooltip" data-tooltip="Motor model name and identification">
                                <div class="card-label">Motor Name</div>
                                <div class="card-value" style="font-size: 1.3rem;">${data.name}</div>
                                <div class="card-description">${data.description || 'N/A'}</div>
                            </div>
                            <div class="card card-tooltip" data-tooltip="Motor category:&#10;‚Ä¢ Gimbal: High resistance, low current&#10;‚Ä¢ High Current: Low resistance, high torque">
                                <div class="card-label">Motor Type</div>
                                <div class="card-value" style="font-size: 1.3rem;">
                                    <span class="badge badge-${data.motor_type}">${data.motor_type || 'N/A'}</span>
                                </div>
                            </div>
                            <div class="card card-tooltip" data-tooltip="Number of magnetic pole pairs in motor.&#10;Affects electrical vs mechanical rotation.&#10;1 electrical rev = ${data.pole_pairs || 'N'} mechanical revs">
                                <div class="card-label">Pole Pairs</div>
                                <div class="card-value">${data.pole_pairs || 'N/A'}</div>
                            </div>
                            <div class="card card-tooltip" data-tooltip="Manufacturer's rated velocity constant.&#10;Motor RPM per volt with no load.&#10;Compare with measured KV for validation.">
                                <div class="card-label">KV Rating</div>
                                <div class="card-value">${data.kv_rating || 'N/A'}</div>
                                <div class="card-unit">RPM/V</div>
                            </div>
                            <div class="card card-tooltip" data-tooltip="DC power supply voltage during testing.&#10;All measurements taken at this voltage.&#10;Affects speed and torque characteristics.">
                                <div class="card-label">‚ö° Bus Voltage</div>
                                <div class="card-value">${data.bus_voltage_V ? data.bus_voltage_V.toFixed(2) : 'N/A'}</div>
                                <div class="card-unit">Volts</div>
                            </div>
                        </div>
                    </div>

                    ${data.image_url ? `
                    <div class="section" style="display: flex; align-items: center; justify-content: center; padding: 15px;">
                        <img src="${data.image_url}" alt="${data.name}" style="max-width: 100%; max-height: 350px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); object-fit: contain;">
                    </div>
                    ` : `
                    <div class="section" style="display: flex; align-items: center; justify-content: center; padding: 40px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
                        <div style="text-align: center; color: #666;">
                            <div style="font-size: 3rem; margin-bottom: 10px;">üì∑</div>
                            <div style="font-size: 1rem;">No image available</div>
                        </div>
                    </div>
                    `}
                </div>

                ${generateElectricalSection(data)}
                ${generateThermalSection(data)}
                ${generateBurstTestSection(data)}
                ${generateInfoPanel()}
            `;

            // Render burst test chart if data exists
            if (data.torque_burst_test && data.torque_burst_test.data && data.torque_burst_test.data.length > 0) {
                renderBurstTestChart(data.torque_burst_test.data, data.torque_burst_test.duration_ms);
                renderTemperatureChart(data.torque_burst_test.data);
            }
        }

        function generateElectricalSection(data) {
            const elec = data.electrical || {};
            const mech = data.mechanical || {};
            const limits = data.limits || {};
            return `
                <div class="compact-grid">
                    <div class="section">
                        <div class="section-title">
                            üîå Electrical
                            <span class="info-icon" data-tooltip="Motor electrical parameters">i</span>
                        </div>
                        <div class="cards-grid">
                            <div class="card card-tooltip" data-tooltip="Electrical resistance of motor windings per phase.&#10;Lower resistance = less heat, more efficient.&#10;Measured in milliohms (mŒ©).">
                                <div class="card-label">Phase Resistance</div>
                                <div class="card-value">${elec.phase_resistance_ohm ? (elec.phase_resistance_ohm * 1000).toFixed(2) : 'N/A'}</div>
                                <div class="card-unit">mŒ©</div>
                            </div>
                            <div class="card card-tooltip" data-tooltip="Winding inductance per phase.&#10;Affects how quickly current can change.&#10;Higher inductance = smoother but slower response.">
                                <div class="card-label">Phase Inductance</div>
                                <div class="card-value">${elec.phase_inductance_mH ? elec.phase_inductance_mH.toFixed(3) : 'N/A'}</div>
                                <div class="card-unit">mH</div>
                            </div>
                            <div class="card card-tooltip" data-tooltip="Torque Constant - torque produced per ampere.&#10;Higher KT = more torque per amp.&#10;Fundamental motor parameter for control.">
                                <div class="card-label">KT (Torque Constant)</div>
                                <div class="card-value">${elec.KT_Nm_per_A ? (elec.KT_Nm_per_A * 1000).toFixed(2) : 'N/A'}</div>
                                <div class="card-unit">mNm/A</div>
                            </div>
                            <div class="card card-tooltip" data-tooltip="Velocity Constant - motor RPM per volt.&#10;Calculated from KT measurement.&#10;Compare with manufacturer's rated KV.">
                                <div class="card-label">KV from KT</div>
                                <div class="card-value">${elec.KV_from_KT_rpm_per_V ? Math.round(elec.KV_from_KT_rpm_per_V) : (elec.KV_rpm_per_V ? Math.round(elec.KV_rpm_per_V) : 'N/A')}</div>
                                <div class="card-unit">RPM/V</div>
                            </div>
                            ${elec.KV_error_percent !== undefined ? `
                            <div class="card card-tooltip" data-tooltip="Difference between measured and rated KV.&#10;<20% is good accuracy.&#10;>20% may indicate measurement error or&#10;manufacturer specification variance.">
                                <div class="card-label">KV Error</div>
                                <div class="card-value ${Math.abs(elec.KV_error_percent) > 20 ? 'highlight-warning' : 'highlight-positive'}">
                                    ${elec.KV_error_percent.toFixed(1)}
                                </div>
                                <div class="card-unit">%</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">
                            ‚öôÔ∏è Mechanical & Limits
                            <span class="info-icon" data-tooltip="Mechanical properties and current limits">i</span>
                        </div>
                        <div class="cards-grid">
                            <div class="card card-tooltip" data-tooltip="Current needed to spin motor freely.&#10;Represents friction and bearing losses.&#10;Lower is better for efficiency.">
                                <div class="card-label">No-Load Current</div>
                                <div class="card-value">${mech.no_load_current_A ? (mech.no_load_current_A * 1000).toFixed(0) : 'N/A'}</div>
                                <div class="card-unit">mA</div>
                            </div>
                            <div class="card card-tooltip" data-tooltip="Rotational inertia of motor rotor.&#10;Resistance to angular acceleration.&#10;Important for dynamic response calculations.">
                                <div class="card-label">Motor Inertia</div>
                                <div class="card-value">${mech.motor_inertia_kg_m2 ? (mech.motor_inertia_kg_m2 * 1e6).toFixed(2) : 'N/A'}</div>
                                <div class="card-unit">g¬∑cm¬≤</div>
                            </div>
                            <div class="card card-tooltip" data-tooltip="Maximum safe continuous current.&#10;Exceeding may cause overheating or damage.&#10;Used as safety limit in tests.">
                                <div class="card-label">Max Current</div>
                                <div class="card-value">${limits.max_current_A || 'N/A'}</div>
                                <div class="card-unit">A</div>
                            </div>
                            <div class="card card-tooltip" data-tooltip="Current used during motor calibration.&#10;Set below max current for safety.&#10;Used to measure resistance and inductance.">
                                <div class="card-label">Calibration Current</div>
                                <div class="card-value">${limits.calibration_current_A || 'N/A'}</div>
                                <div class="card-unit">A</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateMechanicalSection(data) {
            // Now combined with electrical section
            return '';
        }

        function generateThermalSection(data) {
            const thermal = data.thermal || {};

            // Check if we have any thermal data
            if (!thermal.thermal_resistance_C_per_W && !thermal.thermal_time_constant_s) {
                return `
                    <div class="section">
                        <div class="section-title">
                            üå°Ô∏è Thermal Characteristics
                            <span class="info-icon" data-tooltip="Motor thermal properties">i</span>
                        </div>
                        <div class="no-data">No thermal test data available for this motor</div>
                    </div>
                `;
            }

            return `
                <div class="section">
                    <div class="section-title">
                        üå°Ô∏è Thermal Characteristics
                        <span class="info-icon" data-tooltip="Motor thermal properties measured during heating and cooling">i</span>
                    </div>
                    <div class="cards-grid">
                        <div class="card card-tooltip" data-tooltip="Thermal resistance (R_th).&#10;Temperature rise per watt of power dissipated.&#10;Lower is better - motor stays cooler.&#10;&#10;Measured during heating phase with constant current.">
                            <div class="card-label">Thermal Resistance</div>
                            <div class="card-value">${thermal.thermal_resistance_C_per_W ? thermal.thermal_resistance_C_per_W.toFixed(2) : 'N/A'}</div>
                            <div class="card-unit">¬∞C/W</div>
                        </div>
                        <div class="card card-tooltip" data-tooltip="Thermal time constant (œÑ).&#10;Time for temperature to reach 63.2% of final value.&#10;Averaged from heating and cooling phases.&#10;&#10;Larger motors typically have longer time constants.">
                            <div class="card-label">Time Constant (œÑ)</div>
                            <div class="card-value">${thermal.thermal_time_constant_s ? thermal.thermal_time_constant_s.toFixed(1) : 'N/A'}</div>
                            <div class="card-unit">seconds</div>
                        </div>
                    </div>
                    ${thermal.thermal_resistance_C_per_W && thermal.thermal_resistance_C_per_W > 0 ? `
                    <div style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <div style="font-size: 0.95rem; color: #1565c0; font-weight: 500; margin-bottom: 8px;">
                            üí° Thermal Interpretation
                        </div>
                        <div style="font-size: 0.9rem; color: #555; line-height: 1.6;">
                            At continuous operation, this motor will heat up by <strong>${thermal.thermal_resistance_C_per_W.toFixed(1)}¬∞C per watt</strong> of power dissipated.
                            <br>
                            The motor reaches ~63% of its final temperature after <strong>${thermal.thermal_time_constant_s ? thermal.thermal_time_constant_s.toFixed(0) : 'N/A'} seconds</strong>,
                            and ~95% after <strong>${thermal.thermal_time_constant_s ? (3 * thermal.thermal_time_constant_s).toFixed(0) : 'N/A'} seconds</strong>.
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function generateBurstTestSection(data) {
            const burst = data.torque_burst_test;
            if (!burst || !burst.data || burst.data.length === 0) {
                return `
                    <div class="section">
                        <div class="section-title">
                            üìä Torque Burst Test
                            <span class="info-icon" data-tooltip="High-current torque measurement">i</span>
                        </div>
                        <div class="no-data">No burst test data available for this motor</div>
                    </div>
                `;
            }

            // Calculate summary statistics from steady-state portion of burst
            // (10ms after burst start to 10ms before burst end to exclude ramp-up/down)
            const steadyStateData = burst.data.filter(d =>
                d.time_relative_ms >= 10 &&
                d.time_relative_ms <= burst.duration_ms - 10
            );

            const measuredTorques = steadyStateData.map(d => d.measured_torque_Nm).filter(t => !isNaN(t));
            const estimatedTorques = steadyStateData.map(d => d.estimated_torque_Nm).filter(t => !isNaN(t));
            const currents = steadyStateData.map(d => d.current_A).filter(c => !isNaN(c));

            const avgMeasuredTorque = measuredTorques.length > 0 ?
                measuredTorques.reduce((a, b) => a + b, 0) / measuredTorques.length : 0;
            const avgEstimatedTorque = estimatedTorques.length > 0 ?
                estimatedTorques.reduce((a, b) => a + b, 0) / estimatedTorques.length : 0;
            const avgCurrent = currents.length > 0 ?
                currents.reduce((a, b) => a + b, 0) / currents.length : 0;
            const maxMeasuredTorque = measuredTorques.length > 0 ? Math.max(...measuredTorques) : 0;

            // Calculate delta temperature (max - min)
            const temperatures = burst.data.map(d => d.motor_temperature_C).filter(t => t !== null && !isNaN(t));
            const deltaTemp = temperatures.length > 0 ?
                Math.max(...temperatures) - Math.min(...temperatures) : 0;

            // Calculate error between measured and estimated torque
            const torqueError = avgMeasuredTorque !== 0 ?
                Math.abs((avgMeasuredTorque - avgEstimatedTorque) / avgMeasuredTorque * 100) : 0;

            return `
                <div class="section">
                    <div class="section-title">
                        üìä Torque Burst Test (${burst.max_current_A}A for ${burst.duration_ms}ms)
                        <span class="info-icon" data-tooltip="Validates motor KT constant by comparing:&#10;‚Ä¢ Red line: Direct torque sensor measurement&#10;‚Ä¢ Blue line: Estimated (Current √ó KT)&#10;‚Ä¢ Green line: Actual current draw&#10;&#10;Close match = accurate KT calibration&#10;Large difference = calibration issue or inefficiency">i</span>
                    </div>

                    <div class="burst-test-summary">
                        <div class="summary-card card-tooltip" data-tooltip="Average torque measured by sensor.&#10;Calculated from steady-state (10ms-${burst.duration_ms-10}ms).&#10;Excludes ramp-up/down periods." style="cursor: help;">
                            <div class="summary-card-value">${(avgMeasuredTorque * 1000).toFixed(1)}</div>
                            <div class="summary-card-label">Avg Measured (mNm)</div>
                        </div>
                        <div class="summary-card card-tooltip" data-tooltip="Average estimated torque.&#10;Calculated as Current √ó KT.&#10;From steady-state period only." style="cursor: help;">
                            <div class="summary-card-value">${(avgEstimatedTorque * 1000).toFixed(1)}</div>
                            <div class="summary-card-label">Avg Estimated (mNm)</div>
                        </div>
                        <div class="summary-card card-tooltip" data-tooltip="Average motor current during steady-state.&#10;Target: ${burst.max_current_A}A.&#10;Period: 10ms-${burst.duration_ms-10}ms." style="cursor: help;">
                            <div class="summary-card-value">${avgCurrent.toFixed(2)}</div>
                            <div class="summary-card-label">Avg Current (A)</div>
                        </div>
                        <div class="summary-card card-tooltip" data-tooltip="Peak torque in steady-state.&#10;Maximum during 10ms-${burst.duration_ms-10}ms period.&#10;Excludes transients." style="cursor: help;">
                            <div class="summary-card-value">${(maxMeasuredTorque * 1000).toFixed(1)}</div>
                            <div class="summary-card-label">Max Measured (mNm)</div>
                        </div>
                        <div class="summary-card card-tooltip" data-tooltip="Temperature rise during burst test.&#10;Calculated as max temp - min temp.&#10;Indicates thermal stress during test." style="cursor: help;">
                            <div class="summary-card-value">${deltaTemp.toFixed(1)}</div>
                            <div class="summary-card-label">ŒîTemp (¬∞C)</div>
                        </div>
                        <div class="summary-card card-tooltip" data-tooltip="Error between measured and estimated torque.&#10;Calculated as |Measured - Estimated| / Measured √ó 100%.&#10;Lower error = better KT calibration.&#10;<10% is excellent, <20% is good." style="cursor: help;">
                            <div class="summary-card-value">${torqueError.toFixed(1)}</div>
                            <div class="summary-card-label">Torque Error (%)</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="burstChart"></canvas>
                        <div style="text-align: center; margin-top: 10px; color: #666; font-size: 0.9rem;">
                            üí° <strong>Tip:</strong> Mouse wheel to zoom, drag to pan, double-click to reset
                        </div>
                    </div>

                    <div class="chart-container" style="height: 250px; margin-top: 20px;">
                        <canvas id="tempChart"></canvas>
                    </div>
                </div>
            `;
        }

        function generateInfoPanel() {
            return ''; // Removed - info now in tooltips
        }

        function renderBurstTestChart(data, burstDurationMs) {
            const ctx = document.getElementById('burstChart');
            if (!ctx) return;

            // Destroy existing chart
            if (burstChart) {
                burstChart.destroy();
            }

            // Filter data to show 50ms before burst and 50ms after burst ends
            const preBufferMs = 50;
            const postBufferMs = 50;
            const filteredData = data.filter(d =>
                d.time_relative_ms >= -preBufferMs &&
                d.time_relative_ms <= burstDurationMs + postBufferMs
            );

            // Prepare data - use time_relative_ms for x-axis
            const labels = filteredData.map(d => d.time_relative_ms.toFixed(1));
            const measuredTorque = filteredData.map(d => d.measured_torque_Nm * 1000); // Convert to mNm
            const estimatedTorque = filteredData.map(d => d.estimated_torque_Nm * 1000); // Convert to mNm
            const current = filteredData.map(d => d.current_A);

            burstChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Measured Torque (mNm)',
                            data: measuredTorque,
                            borderColor: 'rgb(220, 38, 38)',
                            backgroundColor: 'rgba(220, 38, 38, 0.1)',
                            borderWidth: 3,
                            yAxisID: 'y',
                            tension: 0.2,
                            pointRadius: 2,
                            pointHoverRadius: 4
                        },
                        {
                            label: 'Estimated Torque (mNm)',
                            data: estimatedTorque,
                            borderColor: 'rgb(37, 99, 235)',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderWidth: 3,
                            yAxisID: 'y',
                            tension: 0.2,
                            pointRadius: 2,
                            pointHoverRadius: 4
                        },
                        {
                            label: 'Current (A)',
                            data: current,
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            borderWidth: 2,
                            yAxisID: 'y1',
                            tension: 0.2,
                            pointRadius: 2,
                            pointHoverRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14,
                                    weight: '500'
                                },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                title: function(context) {
                                    return 'Time: ' + context[0].label + ' ms';
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed.y.toFixed(3);
                                    return label;
                                }
                            }
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                    speed: 0.1
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'xy',
                            },
                            pan: {
                                enabled: true,
                                mode: 'xy',
                            },
                            limits: {
                                x: {min: 'original', max: 'original'},
                                y: {min: 'original', max: 'original'},
                                y1: {min: 'original', max: 'original'}
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time Relative to Burst Start (ms)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Torque (mNm)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Current (A)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });
        }

        function renderTemperatureChart(data) {
            const ctx = document.getElementById('tempChart');
            if (!ctx) return;

            // Destroy existing chart
            if (tempChart) {
                tempChart.destroy();
            }

            // Prepare data
            const labels = data.map(d => d.time_relative_ms.toFixed(1));
            const motorTemp = data.map(d => d.motor_temperature_C || null);
            const current = data.map(d => d.current_A);

            tempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Motor Temperature (¬∞C)',
                            data: motorTemp,
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            yAxisID: 'y',
                            tension: 0.2,
                            pointRadius: 1,
                            pointHoverRadius: 3,
                            spanGaps: true
                        },
                        {
                            label: 'Current (A)',
                            data: current,
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            borderWidth: 2,
                            yAxisID: 'y1',
                            tension: 0.2,
                            pointRadius: 1,
                            pointHoverRadius: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 13,
                                    weight: '500'
                                },
                                padding: 10,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                title: function(context) {
                                    return 'Time: ' + context[0].label + ' ms';
                                },
                                label: function(context) {
                                    return context.dataset.label + ': ' + (context.parsed.y !== null ? context.parsed.y.toFixed(1) + '¬∞C' : 'N/A');
                                }
                            }
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                    speed: 0.1
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                            },
                            limits: {
                                x: {min: 'original', max: 'original'}
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time Relative to Burst Start (ms)',
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Temperature (¬∞C)',
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Current (A)',
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // Initial message
        document.getElementById('content').innerHTML = `
            <div class="section" style="text-align: center; padding: 60px 30px;">
                <h2 style="color: #1e3c72; margin-bottom: 20px;">Welcome to Motor Test Results Viewer</h2>
                <p style="font-size: 1.1rem; color: #666; margin-bottom: 30px;">
                    Click the "Choose File" button above to load a motor test result JSON file from your computer.
                </p>
                <div style="background: #f0f4ff; padding: 20px; border-radius: 10px; display: inline-block;">
                    <p style="color: #1e3c72; font-weight: 500;">üìÇ Expected location:</p>
                    <code style="background: white; padding: 8px 16px; border-radius: 6px; display: inline-block; margin-top: 10px;">
                        motorTest/results/*.json
                    </code>
                </div>
            </div>
        `;
    </script>
</body>
</html>
